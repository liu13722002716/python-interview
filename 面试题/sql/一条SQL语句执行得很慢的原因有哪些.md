## 一条SQL语句执行得很慢的原因有哪些?

一个 SQL 执行的很慢，我们要分两种情况讨论：

#### 1、大多数情况下很正常，偶尔很慢，则有如下原因:

    当一条 SQL 大多数情况正常，偶尔才能出现很慢的情况，针对这种情况，我觉得这条SQL语句的书写本身是没什么问题的，而是其他
    原因导致的:
        (1)、数据库在刷新脏页，例如 redo log 写满了需要同步到磁盘。
        
            当我们每次往数据库插入一条数据、或者要更新一条数据的时候,这时数据库会在内存中把对应字段的数据更新了,但是它在
            更新后并不会马上同步持久化到磁盘中去,而是把这些更新的记录保存到 redo log 中的日记中,等到空闲的时候,才会通过 
            redo log 里面的日记,把最新的数据同步到磁盘中去, 但是 redo log 里面的容量是有限度的,如果数据库一直都插入或者
            更新新的数据,当这种时候 redo log 很快就会被写满了,这时候就没有办法等到空闲的时候再把数据同步到磁盘，所以只能
            暂时停止其他操作,来把新的数据同步到磁盘中去的，然而这个时候，就会导致我们平时正常的SQL语句突然执行的很慢，所
            以说，数据库在在同步数据到磁盘的时候，就有可能导致我们的SQL语句执行的很慢了。
            
        (2)、执行的时候，遇到锁，如表锁、行锁。
        
            当我们要执行的这条sql语句，这时这条语句涉及到相关的表同时别人也在使用,并且加l锁,这个时候我们拿不到锁,就只能等
            待别人释放锁了; 或者,当表没有锁的时候,但是需要使用的某一行被加锁了,这个时候,也只能等待别人释放锁!
            
            判断是否真的在等待锁,用 show processlist 命令来查看当前的状态命令

#### 2、在数据量不变的情况下，这条SQL语句一直以来都执行的很慢。
    
    (1)、没有用上索引：例如该字段没有索引；由于对字段进行运算、函数操作导致无法用索引。
        
        字段并没有设置索引
        字段有索引,但是查询的时候却没有用上索引
        如果在字段的左边做了运算,那么在查询的时候,会导致索引无法使用
        如果对字段进行了函数的操作，那么会导致索引无法使用
        
    (2)、数据库选错了索引。(数据库为什么会选错索引,以下解释:)
    
        数据库在执行某行带有索引的语句时,会进行预测: 究竟是走这行索引扫描的行数少,还是直接扫描全表扫描的行数少进行判断,
        当然,扫描的行数越少,速度月越快越好,因为扫描行数越少，意味着I/O操作的次数就越少。
        
    系统是怎么预测:
        系统是通过 "索引的区分度" 来判断的，一个索引上不同的值越多，意味着出现相同数值的索引越少，同时索引的区分度越高。
        我们也把区分度称之为 "基数" ,所以区分度越高，基数越大,基数越大，意味着执行某行带有索引的语句条件的行数越少; 所以
        一个索引的基数越大，意味着走索引查询越有优势,系统就会根据 "基数" 判断到底是走索引还是走全表扫描.
        
    系统怎样获取索引的基数:
        系统是不会遍历整个表的全部索引来获得一个索引的基数的,因为代价太大了,索引系统是通过遍历部分数据,也就是通过采样的
        方式,来预测索引的基数的.
        因为是通过采样的方式来获取"基数",那么就有可能会出现失误的情况,也就是说,某个索引的基数实际上是很大的,但是采取采样
        方法的时候,出现失误的情况,将这个索引的基数预测成很小,例如当你采样的那一部分数据刚好基数很小,然后就误以为索引的基
        数很小。这时由于采样方法统计的失误，导致系统没有走索引，而是走了全表扫描
        
    既然会预测错索引的基数,这也意味着,当我们的查询语句有多个索引的时候,系统有可能也会选错索引,这也可能是 SQL 语句执行的
    很慢的一个原因。
            
    
    
## 索引

**最左前缀原则:**

    定位到最左边，然后向右遍历寻找，就是我们所说的最左前缀原则。
    
**主键索引和非主键索引的区别:**
    
    主键索引存放的值是整行字段的数据，而非主键索引上存放的值不是整行字段的数据，而且存放主键字段的值。

    非主键索引的叶子节点存放的是主键的值，而主键索引的叶子节点存放的是整行数据，其中非主键索引也被称为二级索引，而主键
    索引也被称为聚簇索引。
    
    根据这两种结构我们来进行下查询，看看他们在查询上有什么区别。

    1、如果查询语句是 select * from table where ID = 100,即主键查询的方式，则只需要搜索 ID 这棵 B+树。
    2、如果查询语句是 select * from table where k = 1，即非主键的查询方式，则先搜索k索引树，得到ID=100,再到ID索引树搜索
    一次，这个过程也被称为回表。